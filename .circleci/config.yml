version: '2.1'
commands:
  install_android:
    description: "Install the Android SDK"
    steps:
      - run:
          name: Install Brew Dependencies
          command: brew install --cask android-commandlinetools
      - run:
          name: Configure Android SDK Manager
          command: |
            (yes | sdkmanager "cmdline-tools;latest" "platform-tools" "platforms;android-31" "extras;intel;Hardware_Accelerated_Execution_Manager" "build-tools;28.0.3" "system-images;android-31;google_apis;x86" "emulator" --verbose) || true
            (yes | sdkmanager --licenses) || true
      - run:
          name: Setup environment variables
          command: |
            echo 'export ANDROID_HOME="/usr/local/share/android-commandlinetools"' >> $BASH_ENV
            echo 'export ANDROID_SDK_HOME="${ANDROID_HOME}"' >> $BASH_ENV
            echo 'export ANDROID_SDK_ROOT="${ANDROID_HOME}"' >> $BASH_ENV
            echo 'export PATH="$PATH:~/flutter/bin"'  >> $BASH_ENV
            echo 'export PATH="$PATH:${ANDROID_HOME}/platform-tools"'  >> $BASH_ENV
            echo 'export PATH="$PATH:${ANDROID_HOME}/tools"'  >> $BASH_ENV
            echo 'export PATH="$PATH:${ANDROID_HOME}/sdkmanager"'  >> $BASH_ENV
            echo 'export PATH="$PATH:/usr/local/bin"'  >> $BASH_ENV
            echo 'export PATH="$PATH:${ANDROID_HOME}/cmdline-tools/latest/bin:${ANDROID_HOME}/emulator"'  >> $BASH_ENV
  install_flutter:
    description: "Install Flutter"
    steps:
      - run:
          name: Download Flutter SDK
          command: if ! test -f "~/flutter_sdk.zip"; then curl -o ~/flutter_sdk.zip https://storage.googleapis.com/flutter_infra_release/releases/stable/macos/flutter_macos_2.10.4-stable.zip; fi
      - run:
          name: Unzip Flutter SDK
          command: unzip ~/flutter_sdk.zip -d ~
      - run:
          name: Accept Flutter licenses
          command: (yes | flutter doctor --android-licenses) || true
      - run:
          name: Run Flutter Doctor
          command: flutter doctor
jobs:
  tests:
    docker:
      - image: cirrusci/flutter
    steps:
      - checkout
      - run:
          name: Flutter Doctor
          command: flutter doctor
      - run:
          name: Install App Facing Dependencies
          command: flutter pub get
          working_directory: ./auth0_flutter
      - run:
          name: Install Platform Interface Dependencies
          command: flutter pub get
          working_directory: ./auth0_flutter_platform_interface
      - run:
          name: Run App Facing Tests
          command: flutter test
          working_directory: ./auth0_flutter
      - run:
          name: Run Platform Interface Tests
          command: flutter test
          working_directory: ./auth0_flutter_platform_interface
      - run:
          name: Analyze App Facing Package
          command: dart analyze

          working_directory: ./auth0_flutter
      - run:
          name: Analyze Platform Interface Package
          command: dart analyze
          working_directory: ./auth0_flutter_platform_interface
  test_examples:
    macos:
      xcode: 13
    steps:
      - checkout
      - install_android
      - install_flutter
      - run:
          name: Build Example App
          command: |
            flutter clean
            flutter pub get
            flutter build apk
            flutter build ios --no-codesign
          working_directory: ./auth0_flutter/example
workflows:
  build:
    jobs:
      - tests
      - test_examples
